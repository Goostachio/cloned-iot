# Ordinateur monocarte virtuel

Au lieu d'acheter un dispositif IoT, ainsi que des capteurs et des actionneurs, vous pouvez utiliser votre ordinateur pour simuler le mat√©riel IoT. Le [projet CounterFit](https://github.com/CounterFit-IoT/CounterFit) vous permet d'ex√©cuter localement une application qui simule du mat√©riel IoT, comme des capteurs et des actionneurs, et d'acc√©der aux capteurs et aux actionneurs √† partir d'un code Python local √©crit de la m√™me mani√®re que le code que vous √©cririez sur un Raspberry Pi en utilisant du mat√©riel physique.


## Configuration

Pour utiliser CounterFit, vous devez installer un logiciel gratuit sur votre ordinateur.

### T√¢che

Installez le logiciel requis.

1. Installez Python. Reportez-vous √† la page [Python downloads page](https://www.python.org/downloads/) pour obtenir des instructions sur l'installation de la derni√®re version de Python.

1. Installez Visual Studio Code (VS Code). Il s'agit de l'√©diteur que vous utiliserez pour √©crire le code de votre dispositif virtuel en Python. Reportez-vous √† la [documentation VS Code](https://code.visualstudio.com?WT.mc_id=academic-17441-jabenn) pour obtenir des instructions sur l'installation de VS Code.

    > üíÅ  Vous √™tes libre d'utiliser n'importe quel IDE ou √©diteur Python pour ces le√ßons si vous avez un outil pr√©f√©r√©, mais les le√ßons donneront des instructions bas√©es sur l'utilisation de VS Code.

1. Installez l'extension Pylance de VS Code. Il s'agit d'une extension pour VS Code qui fournit le support du langage Python. Reportez-vous √† la [documentation de l'extension Pylance](https://marketplace.visualstudio.com/items?WT.mc_id=academic-17441-jabenn&itemName=ms-python.vscode-pylance) pour obtenir des instructions sur l'installation de cette extension dans VS Code.

Les instructions d'installation et de configuration de l'application CounterFit seront donn√©es au moment opportun dans les instructions de mission, car elle est install√©e sur la base de chaque projet.

## Bonjour le monde

Il est traditionnel, lorsqu'on commence √† utiliser un nouveau langage de programmation ou une nouvelle technologie, de cr√©er une application "Hello World" - une petite application qui produit quelque chose comme le texte "Hello World" pour montrer que tous les outils sont correctement configur√©s.

L'application Hello World pour le mat√©riel IoT virtuel s'assurera que les codes Python et Visual Studio sont correctement install√©s. Elle se connectera √©galement √† CounterFit pour les capteurs et actionneurs IoT virtuels. Elle n'utilisera aucun mat√©riel, elle se connectera simplement pour prouver que tout fonctionne.

Cette application sera dans un dossier appel√© `nightlight`, et elle sera r√©utilis√©e avec un code diff√©rent dans les parties ult√©rieures de ce travail pour construire l'application de veilleuse.

### Configurer un environnement virtuel Python

L'une des puissantes fonctionnalit√©s de Python est la possibilit√© d'installer des [Pip packages](https://pypi.org). Il s'agit de paquets de code √©crits par d'autres personnes et publi√©s sur Internet. Vous pouvez installer un paquet Pip sur votre ordinateur √† l'aide d'une seule commande, puis utiliser ce paquet dans votre code. Vous allez utiliser Pip pour installer un paquetage pour parler √† CounterFit.

Par d√©faut, lorsque vous installez un paquetage, il est disponible partout sur votre ordinateur, ce qui peut entra√Æner des probl√®mes avec les versions du paquetage - par exemple, une application d√©pendant d'une version d'un paquetage qui se casse lorsque vous installez une nouvelle version pour une autre application. Pour contourner ce probl√®me, vous pouvez utiliser un [environnement virtuel Python](https://docs.python.org/3/library/venv.html), essentiellement une copie de Python dans un dossier d√©di√©, et lorsque vous installez les paquets Pip, ils sont install√©s uniquement dans ce dossier.

> üíÅ Si vous utilisez un Raspberry Pi, vous n'avez pas configur√© d'environnement virtuel sur ce p√©riph√©rique pour g√©rer les paquets Pip, mais vous utilisez des paquets globaux, car les paquets Grove sont install√©s globalement par le script d'installation.

#### T√¢che - configurer un environnement virtuel Python

Configurez un environnement virtuel Python et installez les paquets Pip pour CounterFit.

1. √Ä partir de votre terminal ou de votre ligne de commande, ex√©cutez la commande suivante √† l'endroit de votre choix pour cr√©er et naviguer vers un nouveau r√©pertoire :

    ```sh
    mkdir nightlight
    cd nightlight
    ```

1. Ex√©cutez maintenant ce qui suit pour cr√©er un environnement virtuel dans le dossier `.venv`.

    ```sh
    python3 -m venv .venv
    ```

    > üíÅ Vous devez appeler explicitement `python3` pour cr√©er l'environnement virtuel au cas o√π vous auriez install√© Python 2 en plus de Python 3 (la derni√®re version). Si vous avez install√© Python 2, l'appel de `python` utilisera Python 2 au lieu de Python 3.

1. Activez l'environnement virtuel :

    * Sous Windows :
        * Si vous utilisez l'Invite de commande, ou l'invite de commande via le Terminal Windows, ex√©cutez :

            ```cmd
            .venv\Scripts\activate.bat
            ```

        * Si vous utilisez PowerShell, ex√©cutez :

            ```powershell
            .\.venv\Scripts\Activate.ps1
            ```

    * Sous macOS ou Linux, ex√©cutez:

        ```cmd
        source ./.venv/bin/activate
        ```

    > üíÅ Ces commandes doivent √™tre ex√©cut√©es √† partir du m√™me endroit que celui o√π vous avez ex√©cut√© la commande de cr√©ation de l'environnement virtuel. Vous n'aurez jamais besoin de naviguer dans le dossier `.venv`, vous devez toujours ex√©cuter la commande d'activation et toutes les commandes pour installer des paquets ou ex√©cuter du code √† partir du dossier dans lequel vous √©tiez lorsque vous avez cr√©√© l'environnement virtuel.

1. Une fois l'environnement virtuel activ√©, la commande `python` par d√©faut lancera la version de Python qui a √©t√© utilis√©e pour cr√©er l'environnement virtuel. Ex√©cutez la commande suivante pour obtenir la version:

    ```sh
    python --version
    ```

    La sortie devrait contenir les √©l√©ments suivants:

    ```output
    (.venv) ‚ûú  nightlight python --version
    Python 3.9.1
    ```

    > üíÅ Votre version de Python peut √™tre diff√©rente - tant qu'il s'agit de la version 3.6 ou sup√©rieure, tout va bien. Sinon, supprimez ce dossier, installez une version plus r√©cente de Python et r√©essayez.

1. Ex√©cutez les commandes suivantes pour installer les paquets Pip pour CounterFit. Ces paquets comprennent l'application principale CounterFit ainsi que des cales pour le mat√©riel Grove. Ces cales vous permettent d'√©crire du code comme si vous programmiez √† l'aide de capteurs et d'actionneurs physiques de l'√©cosyst√®me Grove, mais connect√©s √† des dispositifs IoT virtuels.

    ```sh
    pip install CounterFit
    pip install counterfit-connection
    pip install counterfit-shims-grove
    ```

    Ces paquets pip ne seront install√©s que dans l'environnement virtuel, et ne seront pas disponibles en dehors de celui-ci.
### √âcrire le code

Une fois que l'environnement virtuel Python est pr√™t, vous pouvez √©crire le code de l'application 'Hello World'.

#### T√¢che - √©crire le code

Cr√©ez une application Python pour imprimer `"Hello World"` √† la console.

1. Depuis votre terminal ou votre ligne de commande, ex√©cutez ce qui suit √† l'int√©rieur de l'environnement virtuel pour cr√©er un fichier Python appel√© `app.py` :

    * Depuis Windows, ex√©cutez:

        ```cmd
        type nul > app.py
        ```

    * Sous macOS ou Linux, ex√©cutez:

        ```cmd
        touch app.py
        ```

1. Ouvrez le dossier actuel dans VS Code:

    ```sh
    code .
    ```

    > üíÅ Si votre terminal retourne `command not found` sous macOS, cela signifie que VS Code n'a pas √©t√© ajout√© √† votre PATH. Vous pouvez ajouter VS Code √† votre PATH en suivant les instructions de la section [Lancement depuis la ligne de commande de la documentation VS Code](https://code.visualstudio.com/docs/setup/mac?WT.mc_id=academic-17441-jabenn#_launching-from-the-command-line) et ex√©cuter la commande ensuite. VS Code est install√© par d√©faut dans votre PATH sous Windows et Linux.

1. Lorsque VS Code se lance, il active l'environnement virtuel Python. L'environnement virtuel s√©lectionn√© appara√Ætra dans la barre d'√©tat inf√©rieure:

    ![Code VS montrant l'environnement virtuel s√©lectionn√©](../../../images/vscode-virtual-env.png)

1. Si le terminal VS Code est d√©j√† en cours d'ex√©cution lorsque VS Code d√©marre, l'environnement virtuel n'y sera pas activ√©. La chose la plus simple √† faire est de tuer le terminal en utilisant le bouton **Kill the active terminal instance** :

    ![Code VS Tuer le bouton d'instance du terminal actif](../../../images/vscode-kill-terminal.png)

    Vous pouvez savoir si l'environnement virtuel est activ√© sur le terminal car le nom de l'environnement virtuel sera un pr√©fixe sur l'invite du terminal. Par exemple, il peut s'agir de:

    ```sh
    (.venv) ‚ûú  nightlight
    ```

    Si vous n'avez pas `.venv` comme pr√©fixe √† l'invite, l'environnement virtuel n'est pas actif dans le terminal.

1. Lancez un nouveau terminal VS Code en s√©lectionnant *Terminal -> Nouveau terminal, ou en appuyant sur `` CTRL+``. Le nouveau terminal chargera l'environnement virtuel, et l'invite pour l'activer appara√Ætra dans le terminal. L'invite aura √©galement le nom de l'environnement virtuel (`.venv`):

    ```output
    ‚ûú  nightlight source .venv/bin/activate
    (.venv) ‚ûú  nightlight 
    ```

1. Ouvrez le fichier `app.py` depuis l'explorateur de code VS et ajoutez le code suivant:

    ```python
    print('Hello World!')
    ```

    La fonction `print` imprime sur la console ce qui lui est pass√©.

1. Depuis le terminal VS Code, ex√©cutez ce qui suit pour lancer votre application Python:

    ```sh
    python app.py
    ```

    Les √©l√©ments suivants figureront dans la sortie:

    ```output
    (.venv) ‚ûú  nightlight python app.py 
    Hello World!
    ```

üòÄ Votre programme "Hello World" a √©t√© un succ√®s!

### Connectez le "mat√©riel".

Dans un deuxi√®me temps, vous allez ex√©cuter l'application CounterFit et y connecter votre code. C'est l'√©quivalent virtuel de la connexion d'un mat√©riel IoT √† un kit de d√©veloppement.

#### T√¢che - connecter le "mat√©riel".

1. Depuis le terminal VS Code, lancez l'application CounterFit avec la commande suivante:

    ```sh
    counterfit
    ```

    L'application commencera √† fonctionner et s'ouvrira dans votre navigateur web:

    ![L'application Counter Fit fonctionnant dans un navigateur](../../../images/counterfit-first-run.png)

    Il sera marqu√© comme *D√©connect√©*, avec la LED dans le coin sup√©rieur droit √©teinte.

1. Ajoutez le code suivant au d√©but du fichier `app.py`:

    ```python
    from counterfit_connection import CounterFitConnection
    CounterFitConnection.init('127.0.0.1', 5000)
    ```

    Ce code importe la classe `CounterFitConnection` du module `counterfit_connection`, qui provient du paquet pip `counterfit-connection` que vous avez install√© pr√©c√©demment. Il initialise ensuite une connexion √† l'application CounterFit qui tourne sur `127.0.0.1`, qui est une adresse IP que vous pouvez toujours utiliser pour acc√©der √† votre ordinateur local (souvent appel√© *localhost*), sur le port 5000.

    > üíÅ Si vous avez d'autres applications fonctionnant sur le port 5000, vous pouvez changer cela en mettant √† jour le port dans le code, et en ex√©cutant CounterFit en utilisant `CounterFit --port <num√©ro_port>`, en rempla√ßant `<num√©ro_port>` par le port que vous voulez utiliser.

1. Vous devrez lancer un nouveau terminal VS Code en s√©lectionnant le bouton **Cr√©er un nouveau terminal int√©gr√©**. Ceci est d√ª au fait que l'application CounterFit fonctionne dans le terminal actuel.

    ![Code VS Cr√©er un nouveau bouton de terminal int√©gr√©](../../../images/vscode-new-terminal.png)

1. Dans ce nouveau terminal, ex√©cutez le fichier `app.py` comme pr√©c√©demment. Le statut de CounterFit passera √† **Connected** et la LED s'allumera.

    ![Counter Fit appara√Æt comme connect√©](../../../images/counterfit-connected.png)

> üíÅ Vous pouvez trouver ce code dans le dossier[code/virtual-device](code/virtual-device).

üòÄ Votre connexion au mat√©riel a √©t√© un succ√®s!
